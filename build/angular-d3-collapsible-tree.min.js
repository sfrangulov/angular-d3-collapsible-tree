"use strict";function collapsibleTree(){return{restrict:"E",scope:{width:"=",height:"=",radius:"=",nodes:"="},link:function(a,b){function c(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y"),i=parseFloat(c.attr("dy")),j=c.text(null).append("tspan").attr("x",c.attr("x")).attr("y",h).attr("dy",i+"em");a=d.pop();)e.push(a),j.text(e.join(" ")),j.node().getComputedTextLength()>b&&(e.pop(),j.text(e.join(" ")),e=[a],j=c.append("tspan").attr("x",c.attr("x")).attr("y",h).attr("dy",++f*g+i+"em").text(a))})}function d(a){var b=d3.event&&d3.event.altKey?5e3:500,g=k.nodes(f).reverse();g.forEach(function(a){a.y=240*a.depth});var h=m.selectAll("g.node").data(g,function(a){return a.id||(a.id=++j)}),i=h.enter().append("svg:g").attr("class","node").attr("transform",function(b){return"translate("+a.y0+","+a.x0+")"}).on("click",function(a){e(a),d(a)});i.append("svg:circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"});var n=i.append("svg:text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).text(function(a){return a.name}).style("fill-opacity",1e-6);c(n,230);var o=h.transition().duration(b).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});o.select("circle").attr("r",4.5).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),o.select("text").style("fill-opacity",1);var p=h.exit().transition().duration(b).attr("transform",function(b){return"translate("+a.y+","+a.x+")"}).remove();p.select("circle").attr("r",1e-6),p.select("text").style("fill-opacity",1e-6);var q=m.selectAll("path.link").data(k.links(g),function(a){return a.target.id});q.enter().insert("svg:path","g").attr("class","link").attr("d",function(b){var c={x:a.x0,y:a.y0};return l({source:c,target:c})}).transition().duration(b).attr("d",l),q.transition().duration(b).attr("d",l),q.exit().transition().duration(b).attr("d",function(b){var c={x:a.x,y:a.y};return l({source:c,target:c})}).remove(),g.forEach(function(a){a.x0=a.x,a.y0=a.y})}function e(a){!a.children||0!=a.children.length&&null!==a.children||delete a.children,!a._children||0!=a._children.length&&null!==a._hildren||delete a._children,a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null)}var f,g=[20,120,20,120],h=1400-g[1]-g[3],i=1e3-g[0]-g[2],j=0,k=d3.layout.tree().size([i,h]),l=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),m=d3.select("collapsible-tree").append("svg:svg").attr("width",h+g[1]+g[3]).attr("height",i+g[0]+g[2]).append("svg:g").attr("transform","translate("+g[3]+","+g[0]+")");a.$watch("nodes",function(){function b(a){a.children&&(a.children.forEach(b),e(a))}a.nodes&&(f=angular.copy(a.nodes),f.x0=i/2,f.y0=0,f.children.forEach(b),d(f))},!0)}}}var app=angular.module("renderteam.collapsibleTree",[]);app.directive("collapsibleTree",collapsibleTree),collapsibleTree.$inject=[];